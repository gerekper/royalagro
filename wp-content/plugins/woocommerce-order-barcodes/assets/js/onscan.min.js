(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b()):a.onScan=b()})(this,function(){var a={attachTo:function(b,c){if(void 0!==b.scannerDetectionData)throw new Error("onScan.js is already initialized for DOM element "+b);return c=this._mergeOptions({onScan:function(){},onScanError:function(){},onKeyProcess:function(){},onKeyDetect:function(){},onPaste:function(){},keyCodeMapper:function(b){return a.decodeKeyEvent(b)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1},c),b.scannerDetectionData={options:c,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},!0===c.reactToPaste&&b.addEventListener("paste",this._handlePaste,c.captureEvents),!1!==c.scanButtonKeyCode&&b.addEventListener("keyup",this._handleKeyUp,c.captureEvents),(!0===c.reactToKeydown||!1!==c.scanButtonKeyCode)&&b.addEventListener("keydown",this._handleKeyDown,c.captureEvents),this},detachFrom:function(a){return a.scannerDetectionData.options.reactToPaste&&a.removeEventListener("paste",this._handlePaste),!1!==a.scannerDetectionData.options.scanButtonKeyCode&&a.removeEventListener("keyup",this._handleKeyUp),a.removeEventListener("keydown",this._handleKeyDown),void(a.scannerDetectionData=void 0)},getOptions:function(a){return a.scannerDetectionData.options},setOptions:function(a,b){switch(a.scannerDetectionData.options.reactToPaste){case!0:!1===b.reactToPaste&&a.removeEventListener("paste",this._handlePaste);break;case!1:!0===b.reactToPaste&&a.addEventListener("paste",this._handlePaste);}switch(a.scannerDetectionData.options.scanButtonKeyCode){case!1:!1!==b.scanButtonKeyCode&&a.addEventListener("keyup",this._handleKeyUp);break;default:!1===b.scanButtonKeyCode&&a.removeEventListener("keyup",this._handleKeyUp);}return a.scannerDetectionData.options=this._mergeOptions(a.scannerDetectionData.options,b),this._reinitialize(a),this},decodeKeyEvent:function(a){var b=this._getNormalizedKeyNum(a);switch(!0){case 48<=b&&90>=b:case 106<=b&&111>=b:if(a.key!==void 0&&""!==a.key)return a.key;var c=String.fromCharCode(b);switch(a.shiftKey){case!1:c=c.toLowerCase();break;case!0:c=c.toUpperCase();}return c;case 96<=b&&105>=b:return 0+(b-96);}return""},simulate:function(a,b){return this._reinitialize(a),Array.isArray(b)?b.forEach(function(a){var b={};("object"==typeof a||"function"==typeof a)&&null!==a?b=a:b.keyCode=parseInt(a);var c=new KeyboardEvent("keydown",b);document.dispatchEvent(c)}):this._validateScanCode(a,b),this},_reinitialize:function(a){var b=a.scannerDetectionData.vars;return b.firstCharTime=0,b.lastCharTime=0,void(b.accumulatedString="")},_isFocusOnIgnoredElement:function(a){var b=a.scannerDetectionData.options.ignoreIfFocusOn;if(!b)return!1;var c=document.activeElement;if(Array.isArray(b)){for(var d=0;d<b.length;d++)if(!0===c.matches(b[d]))return!0;}else if(c.matches(b))return!0;return!1},_validateScanCode:function(b,c){var d,e=b.scannerDetectionData,f=e.options,g=e.options.singleScanQty,h=e.vars.firstCharTime,i=e.vars.lastCharTime,j={};switch(!0){case c.length<f.minLength:j={message:"Receieved code is shorter then minimal length"};break;case i-h>c.length*f.avgTimeByChar:j={message:"Receieved code was not entered in time"};break;default:return f.onScan.call(b,c,g),d=new CustomEvent("scan",{detail:{scanCode:c,qty:g}}),b.dispatchEvent(d),a._reinitialize(b),!0;}return j.scanCode=c,j.scanDuration=i-h,j.avgTimeByChar=f.avgTimeByChar,j.minLength=f.minLength,f.onScanError.call(b,j),d=new CustomEvent("scanError",{detail:j}),b.dispatchEvent(d),a._reinitialize(b),!1},_mergeOptions:function(a,b){var c,d={};for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(d[c]=b[c]);return d},_getNormalizedKeyNum:function(a){return a.which||a.keyCode},_handleKeyDown:function(b){var c=a._getNormalizedKeyNum(b),d=this.scannerDetectionData.options,e=this.scannerDetectionData.vars,f=!1;if(!1!==d.onKeyDetect.call(this,c,b)&&!a._isFocusOnIgnoredElement(this)){if(!1!==d.scanButtonKeyCode&&c==d.scanButtonKeyCode)return void(e.longPressed||(e.longPressTimer=setTimeout(d.onScanButtonLongPress,d.scanButtonLongPressTime,this),e.longPressed=!0));switch(!0){case e.firstCharTime&&-1!==d.suffixKeyCodes.indexOf(c):b.preventDefault(),b.stopImmediatePropagation(),f=!0;break;case!e.firstCharTime&&-1!==d.prefixKeyCodes.indexOf(c):b.preventDefault(),b.stopImmediatePropagation(),f=!1;break;default:var g=d.keyCodeMapper.call(this,b);if(null===g)return;e.accumulatedString+=g,d.preventDefault&&b.preventDefault(),d.stopPropagation&&b.stopImmediatePropagation(),f=!1;}return e.firstCharTime||(e.firstCharTime=Date.now()),e.lastCharTime=Date.now(),e.testTimer&&clearTimeout(e.testTimer),f?(a._validateScanCode(this,e.accumulatedString),e.testTimer=!1):e.testTimer=setTimeout(a._validateScanCode,d.timeBeforeScanTest,this,e.accumulatedString),void d.onKeyProcess.call(this,g,b)}},_handlePaste:function(b){var c=this.scannerDetectionData.options,d=this.scannerDetectionData.vars,e=(event.clipboardData||window.clipboardData).getData("text");if(!a._isFocusOnIgnoredElement(this))return b.preventDefault(),c.stopPropagation&&b.stopImmediatePropagation(),c.onPaste.call(this,e,event),d.firstCharTime=0,d.lastCharTime=0,void a._validateScanCode(this,e)},_handleKeyUp:function(b){if(!a._isFocusOnIgnoredElement(this)){var c=a._getNormalizedKeyNum(b);c==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)}},isScanInProgressFor:function(a){return 0<a.scannerDetectionData.vars.firstCharTime},isAttachedTo:function(a){return a.scannerDetectionData!==void 0}};return a});